"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const codepipeline = require("@aws-cdk/aws-codepipeline-api");
const iam = require("@aws-cdk/aws-iam");
/**
 * The ECR Repository source CodePipeline Action.
 */
class PipelineSourceAction extends codepipeline.SourceAction {
    constructor(parent, name, props) {
        super(parent, name, Object.assign({ provider: 'ECR', configuration: {
                RepositoryName: props.repository.repositoryName,
                ImageTag: props.imageTag,
            } }, props));
        props.stage.pipeline.role.addToPolicy(new iam.PolicyStatement()
            .addActions('ecr:DescribeImages')
            .addResource(props.repository.repositoryArn));
        props.repository.onImagePushed(props.stage.pipeline.uniqueId + 'SourceEventRule', props.stage.pipeline, props.imageTag);
    }
}
exports.PipelineSourceAction = PipelineSourceAction;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGlwZWxpbmUtYWN0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGlwZWxpbmUtYWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsOERBQStEO0FBQy9ELHdDQUF5QztBQXFDekM7O0dBRUc7QUFDSCxNQUFhLG9CQUFxQixTQUFRLFlBQVksQ0FBQyxZQUFZO0lBQ2pFLFlBQVksTUFBcUIsRUFBRSxJQUFZLEVBQUUsS0FBZ0M7UUFDL0UsS0FBSyxDQUFDLE1BQU0sRUFBRSxJQUFJLGtCQUNoQixRQUFRLEVBQUUsS0FBSyxFQUNmLGFBQWEsRUFBRTtnQkFDYixjQUFjLEVBQUUsS0FBSyxDQUFDLFVBQVUsQ0FBQyxjQUFjO2dCQUMvQyxRQUFRLEVBQUUsS0FBSyxDQUFDLFFBQVE7YUFDekIsSUFDRSxLQUFLLEVBQ1IsQ0FBQztRQUVILEtBQUssQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxHQUFHLENBQUMsZUFBZSxFQUFFO2FBQzVELFVBQVUsQ0FDVCxvQkFBb0IsQ0FDckI7YUFDQSxXQUFXLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1FBRWhELEtBQUssQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLFFBQVEsR0FBRyxpQkFBaUIsRUFDNUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzVDLENBQUM7Q0FDRjtBQXBCRCxvREFvQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY29kZXBpcGVsaW5lID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLWNvZGVwaXBlbGluZS1hcGknKTtcbmltcG9ydCBpYW0gPSByZXF1aXJlKCdAYXdzLWNkay9hd3MtaWFtJyk7XG5pbXBvcnQgY2RrID0gcmVxdWlyZSgnQGF3cy1jZGsvY2RrJyk7XG5pbXBvcnQgeyBJUmVwb3NpdG9yeSB9IGZyb20gJy4vcmVwb3NpdG9yeS1yZWYnO1xuXG4vKipcbiAqIENvbW1vbiBwcm9wZXJ0aWVzIGZvciB0aGUge0BsaW5rIFBpcGVsaW5lU291cmNlQWN0aW9uIENvZGVQaXBlbGluZSBzb3VyY2UgQWN0aW9ufSxcbiAqIHdoZXRoZXIgY3JlYXRpbmcgaXQgZGlyZWN0bHksXG4gKiBvciB0aHJvdWdoIHRoZSB7QGxpbmsgUmVwb3NpdG9yeVJlZiNhZGRUb1BpcGVsaW5lfSBtZXRob2QuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ29tbW9uUGlwZWxpbmVTb3VyY2VBY3Rpb25Qcm9wcyBleHRlbmRzIGNvZGVwaXBlbGluZS5Db21tb25BY3Rpb25Qcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgaW1hZ2UgdGFnIHRoYXQgd2lsbCBiZSBjaGVja2VkIGZvciBjaGFuZ2VzLlxuICAgKlxuICAgKiBAZGVmYXVsdCAnbGF0ZXN0J1xuICAgKi9cbiAgaW1hZ2VUYWc/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoZSBzb3VyY2UncyBvdXRwdXQgYXJ0aWZhY3QuXG4gICAqIE91dHB1dCBhcnRpZmFjdHMgYXJlIHVzZWQgYnkgQ29kZVBpcGVsaW5lIGFzIGlucHV0cyBpbnRvIG90aGVyIGFjdGlvbnMuXG4gICAqXG4gICAqIEBkZWZhdWx0IGEgbmFtZSB3aWxsIGJlIGF1dG8tZ2VuZXJhdGVkXG4gICAqL1xuICBvdXRwdXRBcnRpZmFjdE5hbWU/OiBzdHJpbmc7XG59XG5cbi8qKlxuICogQ29uc3RydWN0aW9uIHByb3BlcnRpZXMgb2Yge0BsaW5rIFBpcGVsaW5lU291cmNlQWN0aW9ufS5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBQaXBlbGluZVNvdXJjZUFjdGlvblByb3BzIGV4dGVuZHMgQ29tbW9uUGlwZWxpbmVTb3VyY2VBY3Rpb25Qcm9wcyxcbiAgICBjb2RlcGlwZWxpbmUuQ29tbW9uQWN0aW9uQ29uc3RydWN0UHJvcHMge1xuICAvKipcbiAgICogVGhlIHJlcG9zaXRvcnkgdGhhdCB3aWxsIGJlIHdhdGNoZWQgZm9yIGNoYW5nZXMuXG4gICAqL1xuICByZXBvc2l0b3J5OiBJUmVwb3NpdG9yeTtcbn1cblxuLyoqXG4gKiBUaGUgRUNSIFJlcG9zaXRvcnkgc291cmNlIENvZGVQaXBlbGluZSBBY3Rpb24uXG4gKi9cbmV4cG9ydCBjbGFzcyBQaXBlbGluZVNvdXJjZUFjdGlvbiBleHRlbmRzIGNvZGVwaXBlbGluZS5Tb3VyY2VBY3Rpb24ge1xuICBjb25zdHJ1Y3RvcihwYXJlbnQ6IGNkay5Db25zdHJ1Y3QsIG5hbWU6IHN0cmluZywgcHJvcHM6IFBpcGVsaW5lU291cmNlQWN0aW9uUHJvcHMpIHtcbiAgICBzdXBlcihwYXJlbnQsIG5hbWUsIHtcbiAgICAgIHByb3ZpZGVyOiAnRUNSJyxcbiAgICAgIGNvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgUmVwb3NpdG9yeU5hbWU6IHByb3BzLnJlcG9zaXRvcnkucmVwb3NpdG9yeU5hbWUsXG4gICAgICAgIEltYWdlVGFnOiBwcm9wcy5pbWFnZVRhZyxcbiAgICAgIH0sXG4gICAgICAuLi5wcm9wcyxcbiAgICB9KTtcblxuICAgIHByb3BzLnN0YWdlLnBpcGVsaW5lLnJvbGUuYWRkVG9Qb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoKVxuICAgICAgLmFkZEFjdGlvbnMoXG4gICAgICAgICdlY3I6RGVzY3JpYmVJbWFnZXMnLFxuICAgICAgKVxuICAgICAgLmFkZFJlc291cmNlKHByb3BzLnJlcG9zaXRvcnkucmVwb3NpdG9yeUFybikpO1xuXG4gICAgcHJvcHMucmVwb3NpdG9yeS5vbkltYWdlUHVzaGVkKHByb3BzLnN0YWdlLnBpcGVsaW5lLnVuaXF1ZUlkICsgJ1NvdXJjZUV2ZW50UnVsZScsXG4gICAgICAgIHByb3BzLnN0YWdlLnBpcGVsaW5lLCBwcm9wcy5pbWFnZVRhZyk7XG4gIH1cbn1cbiJdfQ==