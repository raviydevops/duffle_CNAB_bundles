"use strict";
const cpapi = require("@aws-cdk/aws-codepipeline-api");
const iam = require("@aws-cdk/aws-iam");
const cdk = require("@aws-cdk/cdk");
const _ = require("lodash");
const nodeunit = require("nodeunit");
const cloudformation = require("../lib");
function _assertActionMatches(test, actions, owner, provider, category, configuration) {
    const configurationStr = configuration
        ? `configuration including ${JSON.stringify(cdk.resolve(configuration), null, 2)}`
        : '';
    const actionsStr = JSON.stringify(actions.map(a => ({ owner: a.owner, provider: a.provider, category: a.category, configuration: cdk.resolve(a.configuration) })), null, 2);
    test.ok(_hasAction(actions, owner, provider, category, configuration), `Expected to find an action with owner ${owner}, provider ${provider}, category ${category}${configurationStr}, but found ${actionsStr}`);
}
function _hasAction(actions, owner, provider, category, configuration) {
    for (const action of actions) {
        if (action.owner !== owner) {
            continue;
        }
        if (action.provider !== provider) {
            continue;
        }
        if (action.category !== category) {
            continue;
        }
        if (configuration && !action.configuration) {
            continue;
        }
        if (configuration) {
            for (const key of Object.keys(configuration)) {
                if (!_.isEqual(cdk.resolve(action.configuration[key]), cdk.resolve(configuration[key]))) {
                    continue;
                }
            }
        }
        return true;
    }
    return false;
}
function _assertPermissionGranted(test, statements, action, resource, conditions) {
    const conditionStr = conditions
        ? ` with condition(s) ${JSON.stringify(cdk.resolve(conditions))}`
        : '';
    const resolvedStatements = cdk.resolve(statements);
    const statementsStr = JSON.stringify(resolvedStatements, null, 2);
    test.ok(_grantsPermission(resolvedStatements, action, resource, conditions), `Expected to find a statement granting ${action} on ${JSON.stringify(cdk.resolve(resource))}${conditionStr}, found:\n${statementsStr}`);
}
function _grantsPermission(statements, action, resource, conditions) {
    for (const statement of statements.filter(s => s.Effect === 'Allow')) {
        if (!_isOrContains(statement.Action, action)) {
            continue;
        }
        if (!_isOrContains(statement.Resource, resource)) {
            continue;
        }
        if (conditions && !_isOrContains(statement.Condition, conditions)) {
            continue;
        }
        return true;
    }
    return false;
}
function _isOrContains(entity, value) {
    const resolvedValue = cdk.resolve(value);
    const resolvedEntity = cdk.resolve(entity);
    if (_.isEqual(resolvedEntity, resolvedValue)) {
        return true;
    }
    if (!Array.isArray(resolvedEntity)) {
        return false;
    }
    for (const tested of entity) {
        if (_.isEqual(tested, resolvedValue)) {
            return true;
        }
    }
    return false;
}
function _stackArn(stackName) {
    return cdk.ArnUtils.fromComponents({
        service: 'cloudformation',
        resource: 'stack',
        resourceName: `${stackName}/*`,
    });
}
class PipelineDouble {
    constructor({ pipelineName, role }) {
        this.pipelineName = pipelineName || 'TestPipeline';
        this.pipelineArn = cdk.ArnUtils.fromComponents({ service: 'codepipeline', resource: 'pipeline', resourceName: this.pipelineName });
        this.role = role;
    }
    get uniqueId() {
        throw new Error("Unsupported");
    }
    grantBucketRead() {
        throw new Error("Unsupported");
    }
    grantBucketReadWrite() {
        throw new Error("Unsupported");
    }
    asEventRuleTarget() {
        throw new Error("Unsupported");
    }
}
class StageDouble {
    constructor({ name, pipeline }) {
        this._internal = this;
        this.actions = new Array();
        this.name = name || 'TestStage';
        this.pipeline = pipeline;
    }
    _attachAction(action) {
        this.actions.push(action);
    }
    _generateOutputArtifactName() {
        throw new Error('Unsupported');
    }
    _findInputArtifact() {
        throw new Error('Unsupported');
    }
}
class RoleDouble extends iam.Role {
    constructor(parent, id, props = { assumedBy: new iam.ServicePrincipal('test') }) {
        super(parent, id, props);
        this.statements = new Array();
    }
    addToPolicy(statement) {
        super.addToPolicy(statement);
        this.statements.push(statement);
    }
}
module.exports = nodeunit.testCase({
    'CreateReplaceChangeSet': {
        'works'(test) {
            const stack = new cdk.Stack();
            const pipelineRole = new RoleDouble(stack, 'PipelineRole');
            const stage = new StageDouble({ pipeline: new PipelineDouble({ role: pipelineRole }) });
            const artifact = new cpapi.Artifact(stack, 'TestArtifact');
            const action = new cloudformation.PipelineCreateReplaceChangeSetAction(stack, 'Action', {
                stage,
                changeSetName: 'MyChangeSet',
                stackName: 'MyStack',
                templatePath: artifact.atPath('path/to/file'),
                adminPermissions: false,
            });
            _assertPermissionGranted(test, pipelineRole.statements, 'iam:PassRole', action.role.roleArn);
            const stackArn = _stackArn('MyStack');
            const changeSetCondition = { StringEqualsIfExists: { 'cloudformation:ChangeSetName': 'MyChangeSet' } };
            _assertPermissionGranted(test, pipelineRole.statements, 'cloudformation:DescribeStacks', stackArn, changeSetCondition);
            _assertPermissionGranted(test, pipelineRole.statements, 'cloudformation:DescribeChangeSet', stackArn, changeSetCondition);
            _assertPermissionGranted(test, pipelineRole.statements, 'cloudformation:CreateChangeSet', stackArn, changeSetCondition);
            _assertPermissionGranted(test, pipelineRole.statements, 'cloudformation:DeleteChangeSet', stackArn, changeSetCondition);
            test.deepEqual(action._inputArtifacts, [artifact], 'The inputArtifact was correctly registered');
            _assertActionMatches(test, stage.actions, 'AWS', 'CloudFormation', 'Deploy', {
                ActionMode: 'CHANGE_SET_CREATE_REPLACE',
                StackName: 'MyStack',
                ChangeSetName: 'MyChangeSet'
            });
            test.done();
        },
        'uses a single permission statement if the same ChangeSet name is used'(test) {
            const stack = new cdk.Stack();
            const pipelineRole = new RoleDouble(stack, 'PipelineRole');
            const stage = new StageDouble({ pipeline: new PipelineDouble({ role: pipelineRole }) });
            const artifact = new cpapi.Artifact(stack, 'TestArtifact');
            new cloudformation.PipelineCreateReplaceChangeSetAction(stack, 'ActionA', {
                stage,
                changeSetName: 'MyChangeSet',
                stackName: 'StackA',
                adminPermissions: false,
                templatePath: artifact.atPath('path/to/file')
            });
            new cloudformation.PipelineCreateReplaceChangeSetAction(stack, 'ActionB', {
                stage,
                changeSetName: 'MyChangeSet',
                stackName: 'StackB',
                adminPermissions: false,
                templatePath: artifact.atPath('path/to/other/file')
            });
            test.deepEqual(cdk.resolve(pipelineRole.statements), [
                {
                    Action: 'iam:PassRole',
                    Effect: 'Allow',
                    Resource: [
                        { 'Fn::GetAtt': ['ActionARole72759154', 'Arn'] },
                        { 'Fn::GetAtt': ['ActionBRole6A2F6804', 'Arn'] }
                    ],
                },
                {
                    Action: [
                        'cloudformation:CreateChangeSet',
                        'cloudformation:DeleteChangeSet',
                        'cloudformation:DescribeChangeSet',
                        'cloudformation:DescribeStacks'
                    ],
                    Condition: { StringEqualsIfExists: { 'cloudformation:ChangeSetName': 'MyChangeSet' } },
                    Effect: 'Allow',
                    Resource: [
                        // tslint:disable-next-line:max-line-length
                        { 'Fn::Join': ['', ['arn:', { Ref: 'AWS::Partition' }, ':cloudformation:', { Ref: 'AWS::Region' }, ':', { Ref: 'AWS::AccountId' }, ':stack/StackA/*']] },
                        // tslint:disable-next-line:max-line-length
                        { 'Fn::Join': ['', ['arn:', { Ref: 'AWS::Partition' }, ':cloudformation:', { Ref: 'AWS::Region' }, ':', { Ref: 'AWS::AccountId' }, ':stack/StackB/*']] }
                    ],
                }
            ]);
            test.done();
        }
    },
    'ExecuteChangeSet': {
        'works'(test) {
            const stack = new cdk.Stack();
            const pipelineRole = new RoleDouble(stack, 'PipelineRole');
            const stage = new StageDouble({ pipeline: new PipelineDouble({ role: pipelineRole }) });
            new cloudformation.PipelineExecuteChangeSetAction(stack, 'Action', {
                stage,
                changeSetName: 'MyChangeSet',
                stackName: 'MyStack',
            });
            const stackArn = _stackArn('MyStack');
            _assertPermissionGranted(test, pipelineRole.statements, 'cloudformation:ExecuteChangeSet', stackArn, { StringEquals: { 'cloudformation:ChangeSetName': 'MyChangeSet' } });
            _assertActionMatches(test, stage.actions, 'AWS', 'CloudFormation', 'Deploy', {
                ActionMode: 'CHANGE_SET_EXECUTE',
                StackName: 'MyStack',
                ChangeSetName: 'MyChangeSet'
            });
            test.done();
        },
        'uses a single permission statement if the same ChangeSet name is used'(test) {
            const stack = new cdk.Stack();
            const pipelineRole = new RoleDouble(stack, 'PipelineRole');
            const stage = new StageDouble({ pipeline: new PipelineDouble({ role: pipelineRole }) });
            new cloudformation.PipelineExecuteChangeSetAction(stack, 'ActionA', {
                stage,
                changeSetName: 'MyChangeSet',
                stackName: 'StackA',
            });
            new cloudformation.PipelineExecuteChangeSetAction(stack, 'ActionB', {
                stage,
                changeSetName: 'MyChangeSet',
                stackName: 'StackB',
            });
            test.deepEqual(cdk.resolve(pipelineRole.statements), [
                {
                    Action: 'cloudformation:ExecuteChangeSet',
                    Condition: { StringEquals: { 'cloudformation:ChangeSetName': 'MyChangeSet' } },
                    Effect: 'Allow',
                    Resource: [
                        // tslint:disable-next-line:max-line-length
                        { 'Fn::Join': ['', ['arn:', { Ref: 'AWS::Partition' }, ':cloudformation:', { Ref: 'AWS::Region' }, ':', { Ref: 'AWS::AccountId' }, ':stack/StackA/*']] },
                        // tslint:disable-next-line:max-line-length
                        { 'Fn::Join': ['', ['arn:', { Ref: 'AWS::Partition' }, ':cloudformation:', { Ref: 'AWS::Region' }, ':', { Ref: 'AWS::AccountId' }, ':stack/StackB/*']] }
                    ],
                }
            ]);
            test.done();
        }
    },
    'the CreateUpdateStack Action sets the DescribeStack*, Create/Update/DeleteStack & PassRole permissions'(test) {
        const stack = new cdk.Stack();
        const pipelineRole = new RoleDouble(stack, 'PipelineRole');
        const action = new cloudformation.PipelineCreateUpdateStackAction(stack, 'Action', {
            stage: new StageDouble({ pipeline: new PipelineDouble({ role: pipelineRole }) }),
            templatePath: new cpapi.Artifact(stack, 'TestArtifact').atPath('some/file'),
            stackName: 'MyStack',
            adminPermissions: false,
            replaceOnFailure: true,
        });
        const stackArn = _stackArn('MyStack');
        _assertPermissionGranted(test, pipelineRole.statements, 'cloudformation:DescribeStack*', stackArn);
        _assertPermissionGranted(test, pipelineRole.statements, 'cloudformation:CreateStack', stackArn);
        _assertPermissionGranted(test, pipelineRole.statements, 'cloudformation:UpdateStack', stackArn);
        _assertPermissionGranted(test, pipelineRole.statements, 'cloudformation:DeleteStack', stackArn);
        _assertPermissionGranted(test, pipelineRole.statements, 'iam:PassRole', action.role.roleArn);
        test.done();
    },
    'the DeleteStack Action sets the DescribeStack*, DeleteStack & PassRole permissions'(test) {
        const stack = new cdk.Stack();
        const pipelineRole = new RoleDouble(stack, 'PipelineRole');
        const action = new cloudformation.PipelineDeleteStackAction(stack, 'Action', {
            stage: new StageDouble({ pipeline: new PipelineDouble({ role: pipelineRole }) }),
            adminPermissions: false,
            stackName: 'MyStack',
        });
        const stackArn = _stackArn('MyStack');
        _assertPermissionGranted(test, pipelineRole.statements, 'cloudformation:DescribeStack*', stackArn);
        _assertPermissionGranted(test, pipelineRole.statements, 'cloudformation:DeleteStack', stackArn);
        _assertPermissionGranted(test, pipelineRole.statements, 'iam:PassRole', action.role.roleArn);
        test.done();
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5waXBlbGluZS1hY3Rpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVzdC5waXBlbGluZS1hY3Rpb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSx1REFBd0Q7QUFFeEQsd0NBQXlDO0FBQ3pDLG9DQUFxQztBQUNyQyw0QkFBNkI7QUFDN0IscUNBQXNDO0FBQ3RDLHlDQUEwQztBQTBNMUMsU0FBUyxvQkFBb0IsQ0FBQyxJQUFtQixFQUNuQixPQUF1QixFQUN2QixLQUFhLEVBQ2IsUUFBZ0IsRUFDaEIsUUFBZ0IsRUFDaEIsYUFBc0M7SUFDbEUsTUFBTSxnQkFBZ0IsR0FBRyxhQUFhO1FBQ2YsQ0FBQyxDQUFDLDJCQUEyQixJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxFQUFFO1FBQ2xGLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDNUIsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQ2hELENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDLFFBQVEsRUFBRSxhQUFhLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUM5RyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNaLElBQUksQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxhQUFhLENBQUMsRUFDN0QseUNBQXlDLEtBQUssY0FBYyxRQUFRLGNBQWMsUUFBUSxHQUFHLGdCQUFnQixlQUFlLFVBQVUsRUFBRSxDQUFDLENBQUM7QUFDcEosQ0FBQztBQUVE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ckIsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXRDLHdCQUF3QixDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsVUFBVSxFQUFFLCtCQUErQixFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ25HLHdCQUF3QixDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsVUFBVSxFQUFFLDRCQUE0QixFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRWhHLHdCQUF3QixDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsVUFBVSxFQUFFLGNBQWMsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRTdGLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNkLENBQUM7Q0FDRixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY3BhcGkgPSByZXF1aXJlKCdAYXdzLWNkay9hd3MtY29kZXBpcGVsaW5lLWFwaScpO1xuaW1wb3J0IGV2ZW50cyA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1ldmVudHMnKTtcbmltcG9ydCBpYW0gPSByZXF1aXJlKCdAYXdzLWNkay9hd3MtaWFtJyk7XG5pbXBvcnQgY2RrID0gcmVxdWlyZSgnQGF3cy1jZGsvY2RrJyk7XG5pbXBvcnQgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xuaW1wb3J0IG5vZGV1bml0ID0gcmVxdWlyZSgnbm9kZXVuaXQnKTtcbmltcG9ydCBjbG91ZGZvcm1hdGlvbiA9IHJlcXVpcmUoJy4uL2xpYicpO1xuXG5leHBvcnQgPSBub2RldW5pdC50ZXN0Q2FzZSh7XG4gICdDcmVhdGVSZXBsYWNlQ2hhbmdlU2V0Jzoge1xuICAgICd3b3JrcycodGVzdDogbm9kZXVuaXQuVGVzdCkge1xuICAgICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gICAgICBjb25zdCBwaXBlbGluZVJvbGUgPSBuZXcgUm9sZURvdWJsZShzdGFjaywgJ1BpcGVsaW5lUm9sZScpO1xuICAgICAgY29uc3Qgc3RhZ2UgPSBuZXcgU3RhZ2VEb3VibGUoeyBwaXBlbGluZTogbmV3IFBpcGVsaW5lRG91YmxlKHsgcm9sZTogcGlwZWxpbmVSb2xlIH0pIH0pO1xuICAgICAgY29uc3QgYXJ0aWZhY3QgPSBuZXcgY3BhcGkuQXJ0aWZhY3Qoc3RhY2sgYXMgYW55LCAnVGVzdEFydGlmYWN0Jyk7XG4gICAgICBjb25zdCBhY3Rpb24gPSBuZXcgY2xvdWRmb3JtYXRpb24uUGlwZWxpbmVDcmVhdGVSZXBsYWNlQ2hhbmdlU2V0QWN0aW9uKHN0YWNrLCAnQWN0aW9uJywge1xuICAgICAgICBzdGFnZSxcbiAgICAgICAgY2hhbmdlU2V0TmFtZTogJ015Q2hhbmdlU2V0JyxcbiAgICAgICAgc3RhY2tOYW1lOiAnTXlTdGFjaycsXG4gICAgICAgIHRlbXBsYXRlUGF0aDogYXJ0aWZhY3QuYXRQYXRoKCdwYXRoL3RvL2ZpbGUnKSxcbiAgICAgICAgYWRtaW5QZXJtaXNzaW9uczogZmFsc2UsXG4gICAgICB9KTtcblxuICAgICAgX2Fzc2VydFBlcm1pc3Npb25HcmFudGVkKHRlc3QsIHBpcGVsaW5lUm9sZS5zdGF0ZW1lbnRzLCAnaWFtOlBhc3NSb2xlJywgYWN0aW9uLnJvbGUucm9sZUFybik7XG5cbiAgICAgIGNvbnN0IHN0YWNrQXJuID0gX3N0YWNrQXJuKCdNeVN0YWNrJyk7XG4gICAgICBjb25zdCBjaGFuZ2VTZXRDb25kaXRpb24gPSB7IFN0cmluZ0VxdWFsc0lmRXhpc3RzOiB7ICdjbG91ZGZvcm1hdGlvbjpDaGFuZ2VTZXROYW1lJzogJ015Q2hhbmdlU2V0JyB9IH07XG4gICAgICBfYXNzZXJ0UGVybWlzc2lvbkdyYW50ZWQodGVzdCwgcGlwZWxpbmVSb2xlLnN0YXRlbWVudHMsICdjbG91ZGZvcm1hdGlvbjpEZXNjcmliZVN0YWNrcycsIHN0YWNrQXJuLCBjaGFuZ2VTZXRDb25kaXRpb24pO1xuICAgICAgX2Fzc2VydFBlcm1pc3Npb25HcmFudGVkKHRlc3QsIHBpcGVsaW5lUm9sZS5zdGF0ZW1lbnRzLCAnY2xvdWRmb3JtYXRpb246RGVzY3JpYmVDaGFuZ2VTZXQnLCBzdGFja0FybiwgY2hhbmdlU2V0Q29uZGl0aW9uKTtcbiAgICAgIF9hc3NlcnRQZXJtaXNzaW9uR3JhbnRlZCh0ZXN0LCBwaXBlbGluZVJvbGUuc3RhdGVtZW50cywgJ2Nsb3VkZm9ybWF0aW9uOkNyZWF0ZUNoYW5nZVNldCcsIHN0YWNrQXJuLCBjaGFuZ2VTZXRDb25kaXRpb24pO1xuICAgICAgX2Fzc2VydFBlcm1pc3Npb25HcmFudGVkKHRlc3QsIHBpcGVsaW5lUm9sZS5zdGF0ZW1lbnRzLCAnY2xvdWRmb3JtYXRpb246RGVsZXRlQ2hhbmdlU2V0Jywgc3RhY2tBcm4sIGNoYW5nZVNldENvbmRpdGlvbik7XG5cbiAgICAgIHRlc3QuZGVlcEVxdWFsKGFjdGlvbi5faW5wdXRBcnRpZmFjdHMsIFthcnRpZmFjdF0sXG4gICAgICAgICAgICAgICAgICAgICAnVGhlIGlucHV0QXJ0aWZhY3Qgd2FzIGNvcnJlY3RseSByZWdpc3RlcmVkJyk7XG5cbiAgICAgIF9hc3NlcnRBY3Rpb25NYXRjaGVzKHRlc3QsIHN0YWdlLmFjdGlvbnMsICdBV1MnLCAnQ2xvdWRGb3JtYXRpb24nLCAnRGVwbG95Jywge1xuICAgICAgICBBY3Rpb25Nb2RlOiAnQ0hBTkdFX1NFVF9DUkVBVEVfUkVQTEFDRScsXG4gICAgICAgIFN0YWNrTmFtZTogJ015U3RhY2snLFxuICAgICAgICBDaGFuZ2VTZXROYW1lOiAnTXlDaGFuZ2VTZXQnXG4gICAgICB9KTtcblxuICAgICAgdGVzdC5kb25lKCk7XG4gICAgfSxcblxuICAgICd1c2VzIGEgc2luZ2xlIHBlcm1pc3Npb24gc3RhdGVtZW50IGlmIHRoZSBzYW1lIENoYW5nZVNldCBuYW1lIGlzIHVzZWQnKHRlc3Q6IG5vZGV1bml0LlRlc3QpIHtcbiAgICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICAgICAgY29uc3QgcGlwZWxpbmVSb2xlID0gbmV3IFJvbGVEb3VibGUoc3RhY2ssICdQaXBlbGluZVJvbGUnKTtcbiAgICAgIGNvbnN0IHN0YWdlID0gbmV3IFN0YWdlRG91YmxlKHsgcGlwZWxpbmU6IG5ldyBQaXBlbGluZURvdWJsZSh7IHJvbGU6IHBpcGVsaW5lUm9sZSB9KSB9KTtcbiAgICAgIGNvbnN0IGFydGlmYWN0ID0gbmV3IGNwYXBpLkFydGlmYWN0KHN0YWNrIGFzIGFueSwgJ1Rlc3RBcnRpZmFjdCcpO1xuICAgICAgbmV3IGNsb3VkZm9ybWF0aW9uLlBpcGVsaW5lQ3JlYXRlUmVwbGFjZUNoYW5nZVNldEFjdGlvbihzdGFjaywgJ0FjdGlvbkEnLCB7XG4gICAgICAgIHN0YWdlLFxuICAgICAgICBjaGFuZ2VTZXROYW1lOiAnTXlDaGFuZ2VTZXQnLFxuICAgICAgICBzdGFja05hbWU6ICdTdGFja0EnLFxuICAgICAgICBhZG1pblBlcm1pc3Npb25zOiBmYWxzZSxcbiAgICAgICAgdGVtcGxhdGVQYXRoOiBhcnRpZmFjdC5hdFBhdGgoJ3BhdGgvdG8vZmlsZScpXG4gICAgICB9KTtcblxuICAgICAgbmV3IGNsb3VkZm9ybWF0aW9uLlBpcGVsaW5lQ3JlYXRlUmVwbGFjZUNoYW5nZVNldEFjdGlvbihzdGFjaywgJ0FjdGlvbkInLCB7XG4gICAgICAgIHN0YWdlLFxuICAgICAgICBjaGFuZ2VTZXROYW1lOiAnTXlDaGFuZ2VTZXQnLFxuICAgICAgICBzdGFja05hbWU6ICdTdGFja0InLFxuICAgICAgICBhZG1pblBlcm1pc3Npb25zOiBmYWxzZSxcbiAgICAgICAgdGVtcGxhdGVQYXRoOiBhcnRpZmFjdC5hdFBhdGgoJ3BhdGgvdG8vb3RoZXIvZmlsZScpXG4gICAgICB9KTtcblxuICAgICAgdGVzdC5kZWVwRXF1YWwoXG4gICAgICAgIGNkay5yZXNvbHZlKHBpcGVsaW5lUm9sZS5zdGF0ZW1lbnRzKSxcbiAgICAgICAgW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIEFjdGlvbjogJ2lhbTpQYXNzUm9sZScsXG4gICAgICAgICAgICBFZmZlY3Q6ICdBbGxvdycsXG4gICAgICAgICAgICBSZXNvdXJjZTogW1xuICAgICAgICAgICAgICB7ICdGbjo6R2V0QXR0JzogWyAnQWN0aW9uQVJvbGU3Mjc1OTE1NCcsICdBcm4nIF0gfSxcbiAgICAgICAgICAgICAgeyAnRm46OkdldEF0dCc6IFsgJ0FjdGlvbkJSb2xlNkEyRjY4MDQnLCAnQXJuJyBdIH1cbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBBY3Rpb246IFtcbiAgICAgICAgICAgICAgJ2Nsb3VkZm9ybWF0aW9uOkNyZWF0ZUNoYW5nZVNldCcsXG4gICAgICAgICAgICAgICdjbG91ZGZvcm1hdGlvbjpEZWxldGVDaGFuZ2VTZXQnLFxuICAgICAgICAgICAgICAnY2xvdWRmb3JtYXRpb246RGVzY3JpYmVDaGFuZ2VTZXQnLFxuICAgICAgICAgICAgICAnY2xvdWRmb3JtYXRpb246RGVzY3JpYmVTdGFja3MnXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgQ29uZGl0aW9uOiB7IFN0cmluZ0VxdWFsc0lmRXhpc3RzOiB7ICdjbG91ZGZvcm1hdGlvbjpDaGFuZ2VTZXROYW1lJzogJ015Q2hhbmdlU2V0JyB9IH0sXG4gICAgICAgICAgICBFZmZlY3Q6ICdBbGxvdycsXG4gICAgICAgICAgICBSZXNvdXJjZTogW1xuICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgICAgICAgICAgIHsgJ0ZuOjpKb2luJzogWycnLCBbJ2FybjonLCB7IFJlZjogJ0FXUzo6UGFydGl0aW9uJyB9LCAnOmNsb3VkZm9ybWF0aW9uOicsIHsgUmVmOiAnQVdTOjpSZWdpb24nIH0sICc6JywgeyBSZWY6ICdBV1M6OkFjY291bnRJZCcgfSwgJzpzdGFjay9TdGFja0EvKicgXSBdIH0sXG4gICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgICAgICAgICAgeyAnRm46OkpvaW4nOiBbJycsIFsnYXJuOicsIHsgUmVmOiAnQVdTOjpQYXJ0aXRpb24nIH0sICc6Y2xvdWRmb3JtYXRpb246JywgeyBSZWY6ICdBV1M6OlJlZ2lvbicgfSwgJzonLCB7IFJlZjogJ0FXUzo6QWNjb3VudElkJyB9LCAnOnN0YWNrL1N0YWNrQi8qJyBdIF0gfVxuICAgICAgICAgICAgXSxcbiAgICAgICAgICB9XG4gICAgICAgIF1cbiAgICAgICk7XG5cbiAgICAgIHRlc3QuZG9uZSgpO1xuICAgIH1cbiAgfSxcblxuICAnRXhlY3V0ZUNoYW5nZVNldCc6IHtcbiAgICAnd29ya3MnKHRlc3Q6IG5vZGV1bml0LlRlc3QpIHtcbiAgICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICAgICAgY29uc3QgcGlwZWxpbmVSb2xlID0gbmV3IFJvbGVEb3VibGUoc3RhY2ssICdQaXBlbGluZVJvbGUnKTtcbiAgICAgIGNvbnN0IHN0YWdlID0gbmV3IFN0YWdlRG91YmxlKHsgcGlwZWxpbmU6IG5ldyBQaXBlbGluZURvdWJsZSh7IHJvbGU6IHBpcGVsaW5lUm9sZSB9KSB9KTtcbiAgICAgIG5ldyBjbG91ZGZvcm1hdGlvbi5QaXBlbGluZUV4ZWN1dGVDaGFuZ2VTZXRBY3Rpb24oc3RhY2ssICdBY3Rpb24nLCB7XG4gICAgICAgIHN0YWdlLFxuICAgICAgICBjaGFuZ2VTZXROYW1lOiAnTXlDaGFuZ2VTZXQnLFxuICAgICAgICBzdGFja05hbWU6ICdNeVN0YWNrJyxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBzdGFja0FybiA9IF9zdGFja0FybignTXlTdGFjaycpO1xuICAgICAgX2Fzc2VydFBlcm1pc3Npb25HcmFudGVkKHRlc3QsIHBpcGVsaW5lUm9sZS5zdGF0ZW1lbnRzLCAnY2xvdWRmb3JtYXRpb246RXhlY3V0ZUNoYW5nZVNldCcsIHN0YWNrQXJuLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgU3RyaW5nRXF1YWxzOiB7ICdjbG91ZGZvcm1hdGlvbjpDaGFuZ2VTZXROYW1lJzogJ015Q2hhbmdlU2V0JyB9IH0pO1xuXG4gICAgICBfYXNzZXJ0QWN0aW9uTWF0Y2hlcyh0ZXN0LCBzdGFnZS5hY3Rpb25zLCAnQVdTJywgJ0Nsb3VkRm9ybWF0aW9uJywgJ0RlcGxveScsIHtcbiAgICAgICAgQWN0aW9uTW9kZTogJ0NIQU5HRV9TRVRfRVhFQ1VURScsXG4gICAgICAgIFN0YWNrTmFtZTogJ015U3RhY2snLFxuICAgICAgICBDaGFuZ2VTZXROYW1lOiAnTXlDaGFuZ2VTZXQnXG4gICAgICB9KTtcblxuICAgICAgdGVzdC5kb25lKCk7XG4gICAgfSxcblxuICAgICd1c2VzIGEgc2luZ2xlIHBlcm1pc3Npb24gc3RhdGVtZW50IGlmIHRoZSBzYW1lIENoYW5nZVNldCBuYW1lIGlzIHVzZWQnKHRlc3Q6IG5vZGV1bml0LlRlc3QpIHtcbiAgICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICAgICAgY29uc3QgcGlwZWxpbmVSb2xlID0gbmV3IFJvbGVEb3VibGUoc3RhY2ssICdQaXBlbGluZVJvbGUnKTtcbiAgICAgIGNvbnN0IHN0YWdlID0gbmV3IFN0YWdlRG91YmxlKHsgcGlwZWxpbmU6IG5ldyBQaXBlbGluZURvdWJsZSh7IHJvbGU6IHBpcGVsaW5lUm9sZSB9KSB9KTtcbiAgICAgIG5ldyBjbG91ZGZvcm1hdGlvbi5QaXBlbGluZUV4ZWN1dGVDaGFuZ2VTZXRBY3Rpb24oc3RhY2ssICdBY3Rpb25BJywge1xuICAgICAgICBzdGFnZSxcbiAgICAgICAgY2hhbmdlU2V0TmFtZTogJ015Q2hhbmdlU2V0JyxcbiAgICAgICAgc3RhY2tOYW1lOiAnU3RhY2tBJyxcbiAgICAgIH0pO1xuXG4gICAgICBuZXcgY2xvdWRmb3JtYXRpb24uUGlwZWxpbmVFeGVjdXRlQ2hhbmdlU2V0QWN0aW9uKHN0YWNrLCAnQWN0aW9uQicsIHtcbiAgICAgICAgc3RhZ2UsXG4gICAgICAgIGNoYW5nZVNldE5hbWU6ICdNeUNoYW5nZVNldCcsXG4gICAgICAgIHN0YWNrTmFtZTogJ1N0YWNrQicsXG4gICAgICB9KTtcblxuICAgICAgdGVzdC5kZWVwRXF1YWwoXG4gICAgICAgIGNkay5yZXNvbHZlKHBpcGVsaW5lUm9sZS5zdGF0ZW1lbnRzKSxcbiAgICAgICAgW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIEFjdGlvbjogJ2Nsb3VkZm9ybWF0aW9uOkV4ZWN1dGVDaGFuZ2VTZXQnLFxuICAgICAgICAgICAgQ29uZGl0aW9uOiB7IFN0cmluZ0VxdWFsczogeyAnY2xvdWRmb3JtYXRpb246Q2hhbmdlU2V0TmFtZSc6ICdNeUNoYW5nZVNldCcgfSB9LFxuICAgICAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICAgICAgUmVzb3VyY2U6IFtcbiAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgICAgICAgICAgICB7ICdGbjo6Sm9pbic6IFsnJywgWydhcm46JywgeyBSZWY6ICdBV1M6OlBhcnRpdGlvbicgfSwgJzpjbG91ZGZvcm1hdGlvbjonLCB7IFJlZjogJ0FXUzo6UmVnaW9uJyB9LCAnOicsIHsgUmVmOiAnQVdTOjpBY2NvdW50SWQnIH0sICc6c3RhY2svU3RhY2tBLyonIF0gXSB9LFxuICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgICAgICAgICAgIHsgJ0ZuOjpKb2luJzogWycnLCBbJ2FybjonLCB7IFJlZjogJ0FXUzo6UGFydGl0aW9uJyB9LCAnOmNsb3VkZm9ybWF0aW9uOicsIHsgUmVmOiAnQVdTOjpSZWdpb24nIH0sICc6JywgeyBSZWY6ICdBV1M6OkFjY291bnRJZCcgfSwgJzpzdGFjay9TdGFja0IvKicgXSBdIH1cbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgfVxuICAgICAgICBdXG4gICAgICApO1xuXG4gICAgICB0ZXN0LmRvbmUoKTtcbiAgICB9XG4gIH0sXG5cbiAgJ3RoZSBDcmVhdGVVcGRhdGVTdGFjayBBY3Rpb24gc2V0cyB0aGUgRGVzY3JpYmVTdGFjayosIENyZWF0ZS9VcGRhdGUvRGVsZXRlU3RhY2sgJiBQYXNzUm9sZSBwZXJtaXNzaW9ucycodGVzdDogbm9kZXVuaXQuVGVzdCkge1xuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICAgIGNvbnN0IHBpcGVsaW5lUm9sZSA9IG5ldyBSb2xlRG91YmxlKHN0YWNrLCAnUGlwZWxpbmVSb2xlJyk7XG4gICAgY29uc3QgYWN0aW9uID0gbmV3IGNsb3VkZm9ybWF0aW9uLlBpcGVsaW5lQ3JlYXRlVXBkYXRlU3RhY2tBY3Rpb24oc3RhY2ssICdBY3Rpb24nLCB7XG4gICAgICBzdGFnZTogbmV3IFN0YWdlRG91YmxlKHsgcGlwZWxpbmU6IG5ldyBQaXBlbGluZURvdWJsZSh7IHJvbGU6IHBpcGVsaW5lUm9sZSB9KSB9KSxcbiAgICAgIHRlbXBsYXRlUGF0aDogbmV3IGNwYXBpLkFydGlmYWN0KHN0YWNrIGFzIGFueSwgJ1Rlc3RBcnRpZmFjdCcpLmF0UGF0aCgnc29tZS9maWxlJyksXG4gICAgICBzdGFja05hbWU6ICdNeVN0YWNrJyxcbiAgICAgICAgYWRtaW5QZXJtaXNzaW9uczogZmFsc2UsXG4gICAgICByZXBsYWNlT25GYWlsdXJlOiB0cnVlLFxuICAgIH0pO1xuICAgIGNvbnN0IHN0YWNrQXJuID0gX3N0YWNrQXJuKCdNeVN0YWNrJyk7XG5cbiAgICBfYXNzZXJ0UGVybWlzc2lvbkdyYW50ZWQodGVzdCwgcGlwZWxpbmVSb2xlLnN0YXRlbWVudHMsICdjbG91ZGZvcm1hdGlvbjpEZXNjcmliZVN0YWNrKicsIHN0YWNrQXJuKTtcbiAgICBfYXNzZXJ0UGVybWlzc2lvbkdyYW50ZWQodGVzdCwgcGlwZWxpbmVSb2xlLnN0YXRlbWVudHMsICdjbG91ZGZvcm1hdGlvbjpDcmVhdGVTdGFjaycsIHN0YWNrQXJuKTtcbiAgICBfYXNzZXJ0UGVybWlzc2lvbkdyYW50ZWQodGVzdCwgcGlwZWxpbmVSb2xlLnN0YXRlbWVudHMsICdjbG91ZGZvcm1hdGlvbjpVcGRhdGVTdGFjaycsIHN0YWNrQXJuKTtcbiAgICBfYXNzZXJ0UGVybWlzc2lvbkdyYW50ZWQodGVzdCwgcGlwZWxpbmVSb2xlLnN0YXRlbWVudHMsICdjbG91ZGZvcm1hdGlvbjpEZWxldGVTdGFjaycsIHN0YWNrQXJuKTtcblxuICAgIF9hc3NlcnRQZXJtaXNzaW9uR3JhbnRlZCh0ZXN0LCBwaXBlbGluZVJvbGUuc3RhdGVtZW50cywgJ2lhbTpQYXNzUm9sZScsIGFjdGlvbi5yb2xlLnJvbGVBcm4pO1xuXG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgJ3RoZSBEZWxldGVTdGFjayBBY3Rpb24gc2V0cyB0aGUgRGVzY3JpYmVTdGFjayosIERlbGV0ZVN0YWNrICYgUGFzc1JvbGUgcGVybWlzc2lvbnMnKHRlc3Q6IG5vZGV1bml0LlRlc3QpIHtcbiAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcbiAgICBjb25zdCBwaXBlbGluZVJvbGUgPSBuZXcgUm9sZURvdWJsZShzdGFjaywgJ1BpcGVsaW5lUm9sZScpO1xuICAgIGNvbnN0IGFjdGlvbiA9IG5ldyBjbG91ZGZvcm1hdGlvbi5QaXBlbGluZURlbGV0ZVN0YWNrQWN0aW9uKHN0YWNrLCAnQWN0aW9uJywge1xuICAgICAgc3RhZ2U6IG5ldyBTdGFnZURvdWJsZSh7IHBpcGVsaW5lOiBuZXcgUGlwZWxpbmVEb3VibGUoeyByb2xlOiBwaXBlbGluZVJvbGUgfSkgfSksXG4gICAgICAgIGFkbWluUGVybWlzc2lvbnM6IGZhbHNlLFxuICAgICAgc3RhY2tOYW1lOiAnTXlTdGFjaycsXG4gICAgfSk7XG4gICAgY29uc3Qgc3RhY2tBcm4gPSBfc3RhY2tBcm4oJ015U3RhY2snKTtcblxuICAgIF9hc3NlcnRQZXJtaXNzaW9uR3JhbnRlZCh0ZXN0LCBwaXBlbGluZVJvbGUuc3RhdGVtZW50cywgJ2Nsb3VkZm9ybWF0aW9uOkRlc2NyaWJlU3RhY2sqJywgc3RhY2tBcm4pO1xuICAgIF9hc3NlcnRQZXJtaXNzaW9uR3JhbnRlZCh0ZXN0LCBwaXBlbGluZVJvbGUuc3RhdGVtZW50cywgJ2Nsb3VkZm9ybWF0aW9uOkRlbGV0ZVN0YWNrJywgc3RhY2tBcm4pO1xuXG4gICAgX2Fzc2VydFBlcm1pc3Npb25HcmFudGVkKHRlc3QsIHBpcGVsaW5lUm9sZS5zdGF0ZW1lbnRzLCAnaWFtOlBhc3NSb2xlJywgYWN0aW9uLnJvbGUucm9sZUFybik7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcbn0pO1xuXG5pbnRlcmZhY2UgUG9saWN5U3RhdGVtZW50SnNvbiB7XG4gIEVmZmVjdDogJ0FsbG93JyB8ICdEZW55JztcbiAgQWN0aW9uOiBzdHJpbmcgfCBzdHJpbmdbXTtcbiAgUmVzb3VyY2U6IHN0cmluZyB8wqBzdHJpbmdbXTtcbiAgQ29uZGl0aW9uOiBhbnk7XG59XG5cbmZ1bmN0aW9uIF9hc3NlcnRBY3Rpb25NYXRjaGVzKHRlc3Q6IG5vZGV1bml0LlRlc3QsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25zOiBjcGFwaS5BY3Rpb25bXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG93bmVyOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlcjogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnk6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24/OiB7IFtrZXk6IHN0cmluZ106IGFueSB9KSB7XG4gIGNvbnN0IGNvbmZpZ3VyYXRpb25TdHIgPSBjb25maWd1cmF0aW9uXG4gICAgICAgICAgICAgICAgICAgICAgICAgPyBgY29uZmlndXJhdGlvbiBpbmNsdWRpbmcgJHtKU09OLnN0cmluZ2lmeShjZGsucmVzb2x2ZShjb25maWd1cmF0aW9uKSwgbnVsbCwgMil9YFxuICAgICAgICAgICAgICAgICAgICAgICAgIDogJyc7XG4gIGNvbnN0IGFjdGlvbnNTdHIgPSBKU09OLnN0cmluZ2lmeShhY3Rpb25zLm1hcChhID0+XG4gICAgKHsgb3duZXI6IGEub3duZXIsIHByb3ZpZGVyOiBhLnByb3ZpZGVyLCBjYXRlZ29yeTogYS5jYXRlZ29yeSwgY29uZmlndXJhdGlvbjogY2RrLnJlc29sdmUoYS5jb25maWd1cmF0aW9uKSB9KVxuICApLCBudWxsLCAyKTtcbiAgdGVzdC5vayhfaGFzQWN0aW9uKGFjdGlvbnMsIG93bmVyLCBwcm92aWRlciwgY2F0ZWdvcnksIGNvbmZpZ3VyYXRpb24pLFxuICAgICAgICAgIGBFeHBlY3RlZCB0byBmaW5kIGFuIGFjdGlvbiB3aXRoIG93bmVyICR7b3duZXJ9LCBwcm92aWRlciAke3Byb3ZpZGVyfSwgY2F0ZWdvcnkgJHtjYXRlZ29yeX0ke2NvbmZpZ3VyYXRpb25TdHJ9LCBidXQgZm91bmQgJHthY3Rpb25zU3RyfWApO1xufVxuXG5mdW5jdGlvbiBfaGFzQWN0aW9uKGFjdGlvbnM6IGNwYXBpLkFjdGlvbltdLCBvd25lcjogc3RyaW5nLCBwcm92aWRlcjogc3RyaW5nLCBjYXRlZ29yeTogc3RyaW5nLCBjb25maWd1cmF0aW9uPzogeyBba2V5OiBzdHJpbmddOiBhbnl9KSB7XG4gIGZvciAoY29uc3QgYWN0aW9uIG9mIGFjdGlvbnMpIHtcbiAgICBpZiAoYWN0aW9uLm93bmVyICE9PSBvd25lcinCoHsgY29udGludWU7IH1cbiAgICBpZiAoYWN0aW9uLnByb3ZpZGVyICE9PSBwcm92aWRlcinCoHsgY29udGludWU7IH1cbiAgICBpZiAoYWN0aW9uLmNhdGVnb3J5ICE9PSBjYXRlZ29yeSnCoHsgY29udGludWU7IH1cbiAgICBpZiAoY29uZmlndXJhdGlvbiAmJiAhYWN0aW9uLmNvbmZpZ3VyYXRpb24pIHsgY29udGludWU7IH1cbiAgICBpZiAoY29uZmlndXJhdGlvbikge1xuICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMoY29uZmlndXJhdGlvbikpIHtcbiAgICAgICAgaWYgKCFfLmlzRXF1YWwoY2RrLnJlc29sdmUoYWN0aW9uLmNvbmZpZ3VyYXRpb25ba2V5XSksIGNkay5yZXNvbHZlKGNvbmZpZ3VyYXRpb25ba2V5XSkpKSB7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufVxuXG5mdW5jdGlvbiBfYXNzZXJ0UGVybWlzc2lvbkdyYW50ZWQodGVzdDogbm9kZXVuaXQuVGVzdCwgc3RhdGVtZW50czogaWFtLlBvbGljeVN0YXRlbWVudFtdLCBhY3Rpb246IHN0cmluZywgcmVzb3VyY2U6IHN0cmluZywgY29uZGl0aW9ucz86IGFueSkge1xuICBjb25zdCBjb25kaXRpb25TdHIgPSBjb25kaXRpb25zXG4gICAgICAgICAgICAgICAgICAgICA/IGAgd2l0aCBjb25kaXRpb24ocykgJHtKU09OLnN0cmluZ2lmeShjZGsucmVzb2x2ZShjb25kaXRpb25zKSl9YFxuICAgICAgICAgICAgICAgICAgICAgOiAnJztcbiAgY29uc3QgcmVzb2x2ZWRTdGF0ZW1lbnRzID0gY2RrLnJlc29sdmUoc3RhdGVtZW50cyk7XG4gIGNvbnN0IHN0YXRlbWVudHNTdHIgPSBKU09OLnN0cmluZ2lmeShyZXNvbHZlZFN0YXRlbWVudHMsIG51bGwsIDIpO1xuICB0ZXN0Lm9rKF9ncmFudHNQZXJtaXNzaW9uKHJlc29sdmVkU3RhdGVtZW50cywgYWN0aW9uLCByZXNvdXJjZSwgY29uZGl0aW9ucyksXG4gICAgICAgICAgYEV4cGVjdGVkIHRvIGZpbmQgYSBzdGF0ZW1lbnQgZ3JhbnRpbmcgJHthY3Rpb259IG9uICR7SlNPTi5zdHJpbmdpZnkoY2RrLnJlc29sdmUocmVzb3VyY2UpKX0ke2NvbmRpdGlvblN0cn0sIGZvdW5kOlxcbiR7c3RhdGVtZW50c1N0cn1gKTtcbn1cblxuZnVuY3Rpb24gX2dyYW50c1Blcm1pc3Npb24oc3RhdGVtZW50czogUG9saWN5U3RhdGVtZW50SnNvbltdLCBhY3Rpb246IHN0cmluZywgcmVzb3VyY2U6IHN0cmluZywgY29uZGl0aW9ucz86IGFueSkge1xuICBmb3IgKGNvbnN0IHN0YXRlbWVudCBvZiBzdGF0ZW1lbnRzLmZpbHRlcihzID0+IHMuRWZmZWN0ID09PSAnQWxsb3cnKSkge1xuICAgIGlmICghX2lzT3JDb250YWlucyhzdGF0ZW1lbnQuQWN0aW9uLCBhY3Rpb24pKSB7IGNvbnRpbnVlOyB9XG4gICAgaWYgKCFfaXNPckNvbnRhaW5zKHN0YXRlbWVudC5SZXNvdXJjZSwgcmVzb3VyY2UpKSB7IGNvbnRpbnVlOyB9XG4gICAgaWYgKGNvbmRpdGlvbnMgJiYgIV9pc09yQ29udGFpbnMoc3RhdGVtZW50LkNvbmRpdGlvbiwgY29uZGl0aW9ucykpIHsgY29udGludWU7IH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbmZ1bmN0aW9uIF9pc09yQ29udGFpbnMoZW50aXR5OiBzdHJpbmcgfCBzdHJpbmdbXSwgdmFsdWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICBjb25zdCByZXNvbHZlZFZhbHVlID0gY2RrLnJlc29sdmUodmFsdWUpO1xuICBjb25zdCByZXNvbHZlZEVudGl0eSA9IGNkay5yZXNvbHZlKGVudGl0eSk7XG4gIGlmIChfLmlzRXF1YWwocmVzb2x2ZWRFbnRpdHksIHJlc29sdmVkVmFsdWUpKSB7IHJldHVybiB0cnVlOyB9XG4gIGlmICghQXJyYXkuaXNBcnJheShyZXNvbHZlZEVudGl0eSkpIHsgcmV0dXJuIGZhbHNlOyB9XG4gIGZvciAoY29uc3QgdGVzdGVkIG9mIGVudGl0eSkge1xuICAgIGlmIChfLmlzRXF1YWwodGVzdGVkLCByZXNvbHZlZFZhbHVlKSkgeyByZXR1cm4gdHJ1ZTsgfVxuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cblxuZnVuY3Rpb24gX3N0YWNrQXJuKHN0YWNrTmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIGNkay5Bcm5VdGlscy5mcm9tQ29tcG9uZW50cyh7XG4gICAgc2VydmljZTogJ2Nsb3VkZm9ybWF0aW9uJyxcbiAgICByZXNvdXJjZTogJ3N0YWNrJyxcbiAgICByZXNvdXJjZU5hbWU6IGAke3N0YWNrTmFtZX0vKmAsXG4gIH0pO1xufVxuXG5jbGFzcyBQaXBlbGluZURvdWJsZSBpbXBsZW1lbnRzIGNwYXBpLklQaXBlbGluZSB7XG4gIHB1YmxpYyByZWFkb25seSBwaXBlbGluZU5hbWU6IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IHBpcGVsaW5lQXJuOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSByb2xlOiBpYW0uUm9sZTtcblxuICBjb25zdHJ1Y3Rvcih7IHBpcGVsaW5lTmFtZSwgcm9sZSB9OiB7IHBpcGVsaW5lTmFtZT86IHN0cmluZywgcm9sZTogaWFtLlJvbGUgfSkge1xuICAgIHRoaXMucGlwZWxpbmVOYW1lID0gcGlwZWxpbmVOYW1lIHx8ICdUZXN0UGlwZWxpbmUnO1xuICAgIHRoaXMucGlwZWxpbmVBcm4gPSBjZGsuQXJuVXRpbHMuZnJvbUNvbXBvbmVudHMoeyBzZXJ2aWNlOiAnY29kZXBpcGVsaW5lJywgcmVzb3VyY2U6ICdwaXBlbGluZScsIHJlc291cmNlTmFtZTogdGhpcy5waXBlbGluZU5hbWUgfSk7XG4gICAgdGhpcy5yb2xlID0gcm9sZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgdW5pcXVlSWQoKTogc3RyaW5nIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbnN1cHBvcnRlZFwiKTtcbiAgfVxuXG4gIHB1YmxpYyBncmFudEJ1Y2tldFJlYWQoKTogdm9pZCB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiVW5zdXBwb3J0ZWRcIik7XG4gIH1cblxuICBwdWJsaWMgZ3JhbnRCdWNrZXRSZWFkV3JpdGUoKTogdm9pZCB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiVW5zdXBwb3J0ZWRcIik7XG4gIH1cblxuICBwdWJsaWMgYXNFdmVudFJ1bGVUYXJnZXQoKTogZXZlbnRzLkV2ZW50UnVsZVRhcmdldFByb3BzIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbnN1cHBvcnRlZFwiKTtcbiAgfVxufVxuXG5jbGFzcyBTdGFnZURvdWJsZSBpbXBsZW1lbnRzIGNwYXBpLklTdGFnZSwgY3BhcGkuSUludGVybmFsU3RhZ2Uge1xuICBwdWJsaWMgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgcGlwZWxpbmU6IGNwYXBpLklQaXBlbGluZTtcbiAgcHVibGljIHJlYWRvbmx5IF9pbnRlcm5hbCA9IHRoaXM7XG5cbiAgcHVibGljIHJlYWRvbmx5IGFjdGlvbnMgPSBuZXcgQXJyYXk8Y3BhcGkuQWN0aW9uPigpO1xuXG4gIGNvbnN0cnVjdG9yKHsgbmFtZSwgcGlwZWxpbmUgfTogeyBuYW1lPzogc3RyaW5nLCBwaXBlbGluZTogY3BhcGkuSVBpcGVsaW5lIH0pIHtcbiAgICB0aGlzLm5hbWUgPSBuYW1lIHx8ICdUZXN0U3RhZ2UnO1xuICAgIHRoaXMucGlwZWxpbmUgPSBwaXBlbGluZTtcbiAgfVxuXG4gIHB1YmxpYyBfYXR0YWNoQWN0aW9uKGFjdGlvbjogY3BhcGkuQWN0aW9uKSB7XG4gICAgdGhpcy5hY3Rpb25zLnB1c2goYWN0aW9uKTtcbiAgfVxuXG4gIHB1YmxpYyBfZ2VuZXJhdGVPdXRwdXRBcnRpZmFjdE5hbWUoKTogc3RyaW5nIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkJyk7XG4gIH1cblxuICBwdWJsaWMgX2ZpbmRJbnB1dEFydGlmYWN0KCk6IGNwYXBpLkFydGlmYWN0IHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkJyk7XG4gIH1cbn1cblxuY2xhc3MgUm9sZURvdWJsZSBleHRlbmRzIGlhbS5Sb2xlIHtcbiAgcHVibGljIHJlYWRvbmx5IHN0YXRlbWVudHMgPSBuZXcgQXJyYXk8aWFtLlBvbGljeVN0YXRlbWVudD4oKTtcblxuICBjb25zdHJ1Y3RvcihwYXJlbnQ6IGNkay5Db25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBpYW0uUm9sZVByb3BzID0geyBhc3N1bWVkQnk6IG5ldyBpYW0uU2VydmljZVByaW5jaXBhbCgndGVzdCcpIH0pIHtcbiAgICBzdXBlcihwYXJlbnQsIGlkLCBwcm9wcyk7XG4gIH1cblxuICBwdWJsaWMgYWRkVG9Qb2xpY3koc3RhdGVtZW50OiBpYW0uUG9saWN5U3RhdGVtZW50KSB7XG4gICAgc3VwZXIuYWRkVG9Qb2xpY3koc3RhdGVtZW50KTtcbiAgICB0aGlzLnN0YXRlbWVudHMucHVzaChzdGF0ZW1lbnQpO1xuICB9XG59XG4iXX0=