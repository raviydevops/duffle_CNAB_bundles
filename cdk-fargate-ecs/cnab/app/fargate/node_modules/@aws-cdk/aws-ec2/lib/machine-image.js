"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk_1 = require("@aws-cdk/cdk");
/**
 * Select the latest version of the indicated Windows version
 *
 * The AMI ID is selected using the values published to the SSM parameter store.
 *
 * https://aws.amazon.com/blogs/mt/query-for-the-latest-windows-ami-using-systems-manager-parameter-store/
 */
class WindowsImage {
    constructor(version) {
        this.version = version;
    }
    /**
     * Return the image to use in the given context
     */
    getImage(parent) {
        const ssmProvider = new cdk_1.SSMParameterProvider(parent, {
            parameterName: this.imageParameterName(this.version),
        });
        const ami = ssmProvider.parameterValue();
        return new MachineImage(ami, new WindowsOS());
    }
    /**
     * Construct the SSM parameter name for the given Windows image
     */
    imageParameterName(version) {
        return '/aws/service/ami-windows-latest/' + version;
    }
}
exports.WindowsImage = WindowsImage;
/**
 * Selects the latest version of Amazon Linux
 *
 * The AMI ID is selected using the values published to the SSM parameter store.
 */
class AmazonLinuxImage {
    constructor(props) {
        this.generation = (props && props.generation) || AmazonLinuxGeneration.AmazonLinux;
        this.edition = (props && props.edition) || AmazonLinuxEdition.Standard;
        this.virtualization = (props && props.virtualization) || AmazonLinuxVirt.HVM;
        this.storage = (props && props.storage) || AmazonLinuxStorage.GeneralPurpose;
    }
    /**
     * Return the image to use in the given context
     */
    getImage(parent) {
        const parts = [
            this.generation,
            'ami',
            this.edition !== AmazonLinuxEdition.Standard ? this.edition : undefined,
            this.virtualization,
            'x86_64',
            this.storage
        ].filter(x => x !== undefined); // Get rid of undefineds
        const parameterName = '/aws/service/ami-amazon-linux-latest/' + parts.join('-');
        const ssmProvider = new cdk_1.SSMParameterProvider(parent, {
            parameterName,
        });
        const ami = ssmProvider.parameterValue();
        return new MachineImage(ami, new LinuxOS());
    }
}
exports.AmazonLinuxImage = AmazonLinuxImage;
/**
 * What generation of Amazon Linux to use
 */
var AmazonLinuxGeneration;
(function (AmazonLinuxGeneration) {
    /**
     * Amazon Linux
     */
    AmazonLinuxGeneration["AmazonLinux"] = "amzn";
    /**
     * Amazon Linux 2
     */
    AmazonLinuxGeneration["AmazonLinux2"] = "amzn2";
})(AmazonLinuxGeneration = exports.AmazonLinuxGeneration || (exports.AmazonLinuxGeneration = {}));
/**
 * Amazon Linux edition
 */
var AmazonLinuxEdition;
(function (AmazonLinuxEdition) {
    /**
     * Standard edition
     */
    AmazonLinuxEdition["Standard"] = "standard";
    /**
     * Minimal edition
     */
    AmazonLinuxEdition["Minimal"] = "minimal";
})(AmazonLinuxEdition = exports.AmazonLinuxEdition || (exports.AmazonLinuxEdition = {}));
/**
 * Virtualization type for Amazon Linux
 */
var AmazonLinuxVirt;
(function (AmazonLinuxVirt) {
    /**
     * HVM virtualization (recommended)
     */
    AmazonLinuxVirt["HVM"] = "hvm";
    /**
     * PV virtualization
     */
    AmazonLinuxVirt["PV"] = "pv";
})(AmazonLinuxVirt = exports.AmazonLinuxVirt || (exports.AmazonLinuxVirt = {}));
var AmazonLinuxStorage;
(function (AmazonLinuxStorage) {
    /**
     * EBS-backed storage
     */
    AmazonLinuxStorage["EBS"] = "ebs";
    /**
     * S3-backed storage
     */
    AmazonLinuxStorage["S3"] = "ebs";
    /**
     * General Purpose-based storage (recommended)
     */
    AmazonLinuxStorage["GeneralPurpose"] = "gp2";
})(AmazonLinuxStorage = exports.AmazonLinuxStorage || (exports.AmazonLinuxStorage = {}));
/**
 * Construct a Linux machine image from an AMI map
 *
 * Linux images IDs are not published to SSM parameter store yet, so you'll have to
 * manually specify an AMI map.
 */
class GenericLinuxImage {
    constructor(amiMap) {
        this.amiMap = amiMap;
    }
    getImage(parent) {
        const stack = cdk_1.Stack.find(parent);
        const region = stack.requireRegion('AMI cannot be determined');
        const ami = this.amiMap[region];
        if (!ami) {
            throw new Error(`Unable to find AMI in AMI map: no AMI specified for region '${region}'`);
        }
        return new MachineImage(ami, new LinuxOS());
    }
}
exports.GenericLinuxImage = GenericLinuxImage;
/**
 * The Windows version to use for the WindowsImage
 */
var WindowsVersion;
(function (WindowsVersion) {
    WindowsVersion["WindowsServer2016TurksihFullBase"] = "Windows_Server-2016-Turkish-Full-Base";
    WindowsVersion["WindowsServer2016SwedishFullBase"] = "Windows_Server-2016-Swedish-Full-Base";
    WindowsVersion["WindowsServer2016SpanishFullBase"] = "Windows_Server-2016-Spanish-Full-Base";
    WindowsVersion["WindowsServer2016RussianFullBase"] = "Windows_Server-2016-Russian-Full-Base";
    WindowsVersion["WindowsServer2016PortuguesePortugalFullBase"] = "Windows_Server-2016-Portuguese_Portugal-Full-Base";
    WindowsVersion["WindowsServer2016PortugueseBrazilFullBase"] = "Windows_Server-2016-Portuguese_Brazil-Full-Base";
    WindowsVersion["WindowsServer2016PolishFullBase"] = "Windows_Server-2016-Polish-Full-Base";
    WindowsVersion["WindowsServer2016KoreanFullSQL2016Base"] = "Windows_Server-2016-Korean-Full-SQL_2016_SP1_Standard";
    WindowsVersion["WindowsServer2016KoreanFullBase"] = "Windows_Server-2016-Korean-Full-Base";
    WindowsVersion["WindowsServer2016JapaneseFullSQL2016Web"] = "Windows_Server-2016-Japanese-Full-SQL_2016_SP1_Web";
    WindowsVersion["WindowsServer2016JapaneseFullSQL2016Standard"] = "Windows_Server-2016-Japanese-Full-SQL_2016_SP1_Standard";
    WindowsVersion["WindowsServer2016JapaneseFullSQL2016Express"] = "Windows_Server-2016-Japanese-Full-SQL_2016_SP1_Express";
    WindowsVersion["WindowsServer2016JapaneseFullSQL2016Enterprise"] = "Windows_Server-2016-Japanese-Full-SQL_2016_SP1_Enterprise";
    WindowsVersion["WindowsServer2016JapaneseFullBase"] = "Windows_Server-2016-Japanese-Full-Base";
    WindowsVersion["WindowsServer2016ItalianFullBase"] = "Windows_Server-2016-Italian-Full-Base";
    WindowsVersion["WindowsServer2016HungarianFullBase"] = "Windows_Server-2016-Hungarian-Full-Base";
    WindowsVersion["WindowsServer2016GermanFullBase"] = "Windows_Server-2016-German-Full-Base";
    WindowsVersion["WindowsServer2016FrenchFullBase"] = "Windows_Server-2016-French-Full-Base";
    WindowsVersion["WindowsServer2016EnglishNanoBase"] = "Windows_Server-2016-English-Nano-Base";
    WindowsVersion["WindowsServer2016EnglishFullSQL2017Web"] = "Windows_Server-2016-English-Full-SQL_2017_Web";
    WindowsVersion["WindowsServer2016EnglishFullSQL2017Standard"] = "Windows_Server-2016-English-Full-SQL_2017_Standard";
    WindowsVersion["WindowsServer2016EnglishFullSQL2017Express"] = "Windows_Server-2016-English-Full-SQL_2017_Express";
    WindowsVersion["WindowsServer2016EnglishFullSQL2017Enterprise"] = "Windows_Server-2016-English-Full-SQL_2017_Enterprise";
})(WindowsVersion = exports.WindowsVersion || (exports.WindowsVersion = {}));
/**
 * Representation of a machine to be launched
 *
 * Combines an AMI ID with an OS.
 */
class MachineImage {
    constructor(imageId, os) {
        this.imageId = imageId;
        this.os = os;
    }
}
exports.MachineImage = MachineImage;
/**
 * The OS type of a particular image
 */
var OperatingSystemType;
(function (OperatingSystemType) {
    OperatingSystemType[OperatingSystemType["Linux"] = 0] = "Linux";
    OperatingSystemType[OperatingSystemType["Windows"] = 1] = "Windows";
})(OperatingSystemType = exports.OperatingSystemType || (exports.OperatingSystemType = {}));
/**
 * Abstraction of OS features we need to be aware of
 */
class OperatingSystem {
}
exports.OperatingSystem = OperatingSystem;
/**
 * OS features specialized for Windows
 */
class WindowsOS extends OperatingSystem {
    createUserData(scripts) {
        return `<powershell>${scripts.join('\n')}</powershell>`;
    }
    get type() {
        return OperatingSystemType.Windows;
    }
}
exports.WindowsOS = WindowsOS;
/**
 * OS features specialized for Linux
 */
class LinuxOS extends OperatingSystem {
    createUserData(scripts) {
        return '#!/bin/bash\n' + scripts.join('\n');
    }
    get type() {
        return OperatingSystemType.Linux;
    }
}
exports.LinuxOS = LinuxOS;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFjaGluZS1pbWFnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1hY2hpbmUtaW1hZ2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBc0U7QUFZdEU7Ozs7OztHQU1HO0FBQ0gsTUFBYSxZQUFZO0lBQ3ZCLFlBQTZCLE9BQXVCO1FBQXZCLFlBQU8sR0FBUCxPQUFPLENBQWdCO0lBQ3BELENBQUM7SUFFRDs7T0FFRztJQUNJLFFBQVEsQ0FBQyxNQUFpQjtRQUMvQixNQUFNLFdBQVcsR0FBRyxJQUFJLDBCQUFvQixDQUFDLE1BQU0sRUFBRTtZQUNuRCxhQUFhLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7U0FDckQsQ0FBQyxDQUFDO1FBRUgsTUFBTSxHQUFHLEdBQUcsV0FBVyxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3pDLE9BQU8sSUFBSSxZQUFZLENBQUMsR0FBRyxFQUFFLElBQUksU0FBUyxFQUFFLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxrQkFBa0IsQ0FBQyxPQUF1QjtRQUNoRCxPQUFPLGtDQUFrQyxHQUFHLE9BQU8sQ0FBQztJQUN0RCxDQUFDO0NBQ0Y7QUF0QkQsb0NBc0JDO0FBbUNEOzs7O0dBSUc7QUFDSCxNQUFhLGdCQUFnQjtJQU0zQixZQUFZLEtBQTZCO1FBQ3ZDLElBQUksQ0FBQyxVQUFVLEdBQUcsQ0FBQyxLQUFLLElBQUksS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUFJLHFCQUFxQixDQUFDLFdBQVcsQ0FBQztRQUNuRixJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsS0FBSyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxrQkFBa0IsQ0FBQyxRQUFRLENBQUM7UUFDdkUsSUFBSSxDQUFDLGNBQWMsR0FBRyxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsY0FBYyxDQUFDLElBQUksZUFBZSxDQUFDLEdBQUcsQ0FBQztRQUM3RSxJQUFJLENB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SSxJQUFJO1FBQ04sT0FBTyxtQkFBbUIsQ0FBQyxPQUFPLENBQUM7SUFDckMsQ0FBQztDQUNGO0FBUkQsOEJBUUM7QUFFRDs7R0FFRztBQUNILE1BQWEsT0FBUSxTQUFRLGVBQWU7SUFDbkMsY0FBYyxDQUFDLE9BQWlCO1FBQ3JDLE9BQU8sZUFBZSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUVELElBQUksSUFBSTtRQUNOLE9BQU8sbUJBQW1CLENBQUMsS0FBSyxDQUFDO0lBQ25DLENBQUM7Q0FDRjtBQVJELDBCQVFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0LCBTU01QYXJhbWV0ZXJQcm92aWRlciwgU3RhY2sgfSBmcm9tICdAYXdzLWNkay9jZGsnO1xuXG4vKipcbiAqIEludGVyZmFjZSBmb3IgY2xhc3NlcyB0aGF0IGNhbiBzZWxlY3QgYW4gYXBwcm9wcmlhdGUgbWFjaGluZSBpbWFnZSB0byB1c2VcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJTWFjaGluZUltYWdlU291cmNlIHtcbiAgLyoqXG4gICAqIFJldHVybiB0aGUgaW1hZ2UgdG8gdXNlIGluIHRoZSBnaXZlbiBjb250ZXh0XG4gICAqL1xuICBnZXRJbWFnZShwYXJlbnQ6IENvbnN0cnVjdCk6IE1hY2hpbmVJbWFnZTtcbn1cblxuLyoqXG4gKiBTZWxlY3QgdGhlIGxhdGVzdCB2ZXJzaW9uIG9mIHRoZSBpbmRpY2F0ZWQgV2luZG93cyB2ZXJzaW9uXG4gKlxuICogVGhlIEFNSSBJRCBpcyBzZWxlY3RlZCB1c2luZyB0aGUgdmFsdWVzIHB1Ymxpc2hlZCB0byB0aGUgU1NNIHBhcmFtZXRlciBzdG9yZS5cbiAqXG4gKiBodHRwczovL2F3cy5hbWF6b24uY29tL2Jsb2dzL210L3F1ZXJ5LWZvci10aGUtbGF0ZXN0LXdpbmRvd3MtYW1pLXVzaW5nLXN5c3RlbXMtbWFuYWdlci1wYXJhbWV0ZXItc3RvcmUvXG4gKi9cbmV4cG9ydCBjbGFzcyBXaW5kb3dzSW1hZ2UgaW1wbGVtZW50cyBJTWFjaGluZUltYWdlU291cmNlICB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgdmVyc2lvbjogV2luZG93c1ZlcnNpb24pIHtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gdGhlIGltYWdlIHRvIHVzZSBpbiB0aGUgZ2l2ZW4gY29udGV4dFxuICAgKi9cbiAgcHVibGljIGdldEltYWdlKHBhcmVudDogQ29uc3RydWN0KTogTWFjaGluZUltYWdlIHtcbiAgICBjb25zdCBzc21Qcm92aWRlciA9IG5ldyBTU01QYXJhbWV0ZXJQcm92aWRlcihwYXJlbnQsIHtcbiAgICAgIHBhcmFtZXRlck5hbWU6IHRoaXMuaW1hZ2VQYXJhbWV0ZXJOYW1lKHRoaXMudmVyc2lvbiksXG4gICAgfSk7XG5cbiAgICBjb25zdCBhbWkgPSBzc21Qcm92aWRlci5wYXJhbWV0ZXJWYWx1ZSgpO1xuICAgIHJldHVybiBuZXcgTWFjaGluZUltYWdlKGFtaSwgbmV3IFdpbmRvd3NPUygpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb25zdHJ1Y3QgdGhlIFNTTSBwYXJhbWV0ZXIgbmFtZSBmb3IgdGhlIGdpdmVuIFdpbmRvd3MgaW1hZ2VcbiAgICovXG4gIHByaXZhdGUgaW1hZ2VQYXJhbWV0ZXJOYW1lKHZlcnNpb246IFdpbmRvd3NWZXJzaW9uKTogc3RyaW5nIHtcbiAgICByZXR1cm4gJy9hd3Mvc2VydmljZS9hbWktd2luZG93cy1sYXRlc3QvJyArIHZlcnNpb247XG4gIH1cbn1cblxuLyoqXG4gKiBBbWF6b24gTGludXggaW1hZ2UgcHJvcGVydGllc1xuICovXG5leHBvcnQgaW50ZXJmYWNlIEFtYXpvbkxpbnV4SW1hZ2VQcm9wcyB7XG4gIC8qKlxuICAgKiBXaGF0IGdlbmVyYXRpb24gb2YgQW1hem9uIExpbnV4IHRvIHVzZVxuICAgKlxuICAgKiBAZGVmYXVsdCBBbWF6b25MaW51eFxuICAgKi9cbiAgZ2VuZXJhdGlvbj86IEFtYXpvbkxpbnV4R2VuZXJhdGlvbjtcblxuICAvKipcbiAgICogV2hhdCBlZGl0aW9uIG9mIEFtYXpvbiBMaW51eCB0byB1c2VcbiAgICpcbiAgICogQGRlZmF1bHQgU3RhbmRhcmRcbiAgICovXG4gIGVkaXRpb24/OiBBbWF6b25MaW51eEVkaXRpb247XG5cbiAgLyoqXG4gICAqIFZpcnR1YWxpemF0aW9uIHR5cGVcbiAgICpcbiAgICogQGRlZmF1bHQgSFZNXG4gICAqL1xuICB2aXJ0dWFsaXphdGlvbj86IEFtYXpvbkxpbnV4VmlydDtcblxuICAvKipcbiAgICogV2hhdCBzdG9yYWdlIGJhY2tlZCBpbWFnZSB0byB1c2VcbiAgICpcbiAgICogQGRlZmF1bHQgR2VuZXJhbFB1cnBvc2VcbiAgICovXG4gIHN0b3JhZ2U/OiBBbWF6b25MaW51eFN0b3JhZ2U7XG59XG5cbi8qKlxuICogU2VsZWN0cyB0aGUgbGF0ZXN0IHZlcnNpb24gb2YgQW1hem9uIExpbnV4XG4gKlxuICogVGhlIEFNSSBJRCBpcyBzZWxlY3RlZCB1c2luZyB0aGUgdmFsdWVzIHB1Ymxpc2hlZCB0byB0aGUgU1NNIHBhcmFtZXRlciBzdG9yZS5cbiAqL1xuZXhwb3J0IGNsYXNzIEFtYXpvbkxpbnV4SW1hZ2UgaW1wbGVtZW50cyBJTWFjaGluZUltYWdlU291cmNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBnZW5lcmF0aW9uOiBBbWF6b25MaW51eEdlbmVyYXRpb247XG4gIHByaXZhdGUgcmVhZG9ubHkgZWRpdGlvbjogQW1hem9uTGludXhFZGl0aW9uO1xuICBwcml2YXRlIHJlYWRvbmx5IHZpcnR1YWxpemF0aW9uOiBBbWF6b25MaW51eFZpcnQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgc3RvcmFnZTogQW1hem9uTGludXhTdG9yYWdlO1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzPzogQW1hem9uTGludXhJbWFnZVByb3BzKSB7XG4gICAgdGhpcy5nZW5lcmF0aW9uID0gKHByb3BzICYmIHByb3BzLmdlbmVyYXRpb24pIHx8IEFtYXpvbkxpbnV4R2VuZXJhdGlvbi5BbWF6b25MaW51eDtcbiAgICB0aGlzLmVkaXRpb24gPSAocHJvcHMgJiYgcHJvcHMuZWRpdGlvbikgfHwgQW1hem9uTGludXhFZGl0aW9uLlN0YW5kYXJkO1xuICAgIHRoaXMudmlydHVhbGl6YXRpb24gPSAocHJvcHMgJiYgcHJvcHMudmlydHVhbGl6YXRpb24pIHx8IEFtYXpvbkxpbnV4VmlydC5IVk07XG4gICAgdGhpcy5zdG9yYWdlID0gKHByb3BzICYmIHByb3BzLnN0b3JhZ2UpIHx8IEFtYXpvbkxpbnV4U3RvcmFnZS5HZW5lcmFsUHVycG9zZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gdGhlIGltYWdlIHRvIHVzZSBpbiB0aGUgZ2l2ZW4gY29udGV4dFxuICAgKi9cbiAgcHVibGljIGdldEltYWdlKHBhcmVudDogQ29uc3RydWN0KTogTWFjaGluZUltYWdlIHtcbiAgICBjb25zdCBwYXJ0czogQXJyYXk8c3RyaW5nfHVuZGVmaW5lZD4gPSBbXG4gICAgICB0aGlzLmdlbmVyYXRpb24sXG4gICAgICAnYW1pJyxcbiAgICAgIHRoaXMuZWRpdGlvbiAhPT0gQW1hem9uTGludXhFZGl0aW9uLlN0YW5kYXJkID8gdGhpcy5lZGl0aW9uIDogdW5kZWZpbmVkLFxuICAgICAgdGhpcy52aXJ0dWFsaXphdGlvbixcbiAgICAgICd4ODZfNjQnLCAvLyBObyAzMi1iaXRzIGltYWdlcyB2ZW5kZWQgdGhyb3VnaCB0aGlzXG4gICAgICB0aGlzLnN0b3JhZ2VcbiAgICBdLmZpbHRlcih4ID0+IHggIT09IHVuZGVmaW5lZCk7IC8vIEdldCByaWQgb2YgdW5kZWZpbmVkc1xuXG4gICAgY29uc3QgcGFyYW1ldGVyTmFtZSA9ICcvYXdzL3NlcnZpY2UvYW1pLWFtYXpvbi1saW51eC1sYXRlc3QvJyArIHBhcnRzLmpvaW4oJy0nKTtcblxuICAgIGNvbnN0IHNzbVByb3ZpZGVyID0gbmV3IFNTTVBhcmFtZXRlclByb3ZpZGVyKHBhcmVudCwge1xuICAgICAgcGFyYW1ldGVyTmFtZSxcbiAgICB9KTtcbiAgICBjb25zdCBhbWkgPSBzc21Qcm92aWRlci5wYXJhbWV0ZXJWYWx1ZSgpO1xuICAgIHJldHVybiBuZXcgTWFjaGluZUltYWdlKGFtaSwgbmV3IExpbnV4T1MoKSk7XG4gIH1cbn1cblxuLyoqXG4gKiBXaGF0IGdlbmVyYXRpb24gb2YgQW1hem9uIExpbnV4IHRvIHVzZVxuICovXG5leHBvcnQgZW51bSBBbWF6b25MaW51eEdlbmVyYXRpb24ge1xuICAvKipcbiAgICogQW1hem9uIExpbnV4XG4gICAqL1xuICBBbWF6b25MaW51eCA9ICdhbXpuJyxcblxuICAvKipcbiAgICogQW1hem9uIExpbnV4IDJcbiAgICovXG4gIEFtYXpvbkxpbnV4MiA9ICdhbXpuMicsXG59XG5cbi8qKlxuICogQW1hem9uIExpbnV4IGVkaXRpb25cbiAqL1xuZXhwb3J0IGVudW0gQW1hem9uTGludXhFZGl0aW9uIHtcbiAgLyoqXG4gICAqIFN0YW5kYXJkIGVkaXRpb25cbiAgICovXG4gIFN0YW5kYXJkID0gJ3N0YW5kYXJkJyxcblxuICAvKipcbiAgICogTWluaW1hbCBlZGl0aW9uXG4gICAqL1xuICBNaW5pbWFsID0gJ21pbmltYWwnXG59XG5cbi8qKlxuICogVmlydHVhbGl6YXRpb24gdHlwZSBmb3IgQW1hem9uIExpbnV4XG4gKi9cbmV4cG9ydCBlbnVtIEFtYXpvbkxpbnV4VmlydCB7XG4gIC8qKlxuICAgKiBIVk0gdmlydHVhbGl6YXRpb24gKHJlY29tbWVuZGVkKVxuICAgKi9cbiAgSFZNID0gJ2h2bScsXG5cbiAgLyoqXG4gICAqIFBWIHZpcnR1YWxpemF0aW9uXG4gICAqL1xuICBQViA9ICdwdidcbn1cblxuZXhwb3J0IGVudW0gQW1hem9uTGludXhTdG9yYWdlIHtcbiAgLyoqXG4gICAqIEVCUy1iYWNrZWQgc3RvcmFnZVxuICAgKi9cbiAgRUJTID0gJ2VicycsXG5cbiAgLyoqXG4gICAqIFMzLWJhY2tlZCBzdG9yYWdlXG4gICAqL1xuICBTMyA9ICdlYnMnLFxuXG4gIC8qKlxuICAgKiBHZW5lcmFsIFB1cnBvc2UtYmFzZWQgc3RvcmFnZSAocmVjb21tZW5kZWQpXG4gICAqL1xuICBHZW5lcmFsUHVycG9zZSA9ICdncDInLFxufVxuXG4vKipcbiAqIENvbnN0cnVjdCBhIExpbnV4IG1hY2hpbmUgaW1hZ2UgZnJvbSBhbiBBTUkgbWFwXG4gKlxuICogTGludXggaW1hZ2VzIElEcyBhcmUgbm90IHB1Ymxpc2hlZCB0byBTU00gcGFyYW1ldGVyIHN0b3JlIHlldCwgc28geW91J2xsIGhhdmUgdG9cbiAqIG1hbnVhbGx5IHNwZWNpZnkgYW4gQU1JIG1hcC5cbiAqL1xuZXhwb3J0IGNsYXNzIEdlbmVyaWNMaW51eEltYWdlIGltcGxlbWVudHMgSU1hY2hpbmVJbWFnZVNvdXJjZSAge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGFtaU1hcDoge1tyZWdpb246IHN0cmluZ106IHN0cmluZ30pIHtcbiAgfVxuXG4gIHB1YmxpYyBnZXRJbWFnZShwYXJlbnQ6IENvbnN0cnVjdCk6IE1hY2hpbmVJbWFnZSB7XG4gICAgY29uc3Qgc3RhY2sgPSBTdGFjay5maW5kKHBhcmVudCk7XG4gICAgY29uc3QgcmVnaW9uID0gc3RhY2sucmVxdWlyZVJlZ2lvbignQU1JIGNhbm5vdCBiZSBkZXRlcm1pbmVkJyk7XG4gICAgY29uc3QgYW1pID0gdGhpcy5hbWlNYXBbcmVnaW9uXTtcbiAgICBpZiAoIWFtaSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gZmluZCBBTUkgaW4gQU1JIG1hcDogbm8gQU1JIHNwZWNpZmllZCBmb3IgcmVnaW9uICcke3JlZ2lvbn0nYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBNYWNoaW5lSW1hZ2UoYW1pLCBuZXcgTGludXhPUygpKTtcbiAgfVxufVxuXG4vKipcbiAqIFRoZSBXaW5kb3dzIHZlcnNpb24gdG8gdXNlIGZvciB0aGUgV2luZG93c0ltYWdlXG4gKi9cbmV4cG9ydCBlbnVtIFdpbmRvd3NWZXJzaW9uIHtcbiAgV2luZG93c1NlcnZlcjIwMTZUdXJrc2loRnVsbEJhc2UgPSAnV2luZG93c19TZXJ2ZXItMjAxNi1UdXJraXNoLUZ1bGwtQmFzZScsXG4gIFdpbmRvd3NTZXJ2ZXIyMDE2U3dlZGlzaEZ1bGxCYXNlID0gJ1dpbmRvd3NfU2VydmVyLTIwMTYtU3dlZGlzaC1GdWxsLUJhc2UnLFxuICBXaW5kb3dzU2VydmVyMjAxNlNwYW5pc2hGdWxsQmFzZSA9ICdXaW5kb3dzX1NlcnZlci0yMDE2LVNwYW5pc2gtRnVsbC1CYXNlJyxcbiAgV2luZG93c1NlcnZlcjIwMTZSdXNzaWFuRnVsbEJhc2UgPSAnV2luZG93c19TZXJ2ZXItMjAxNi1SdXNzaWFuLUZ1bGwtQmFzZScsXG4gIFdpbmRvd3NTZXJ2ZXIyMDE2UG9ydHVndWVzZVBvcnR1Z2FsRnVsbEJhc2UgPSAnV2luZG93c19TZXJ2ZXItMjAxNi1Qb3J0dWd1ZXNlX1BvcnR1Z2FsLUZ1bGwtQmFzZScsXG4gIFdpbmRvd3NTZXJ2ZXIyMDE2UG9ydHVndWVzZUJyYXppbEZ1bGxCYXNlID0gJ1dpbmRvd3NfU2VydmVyLTIwMTYtUG9ydHVndWVzZV9CcmF6aWwtRnVsbC1CYXNlJyxcbiAgV2luZG93c1NlcnZlcjIwMTZQb2xpc2hGdWxsQmFzZSA9ICdXaW5kb3dzX1NlcnZlci0yMDE2LVBvbGlzaC1GdWxsLUJhc2UnLFxuICBXaW5kb3dzU2VydmVyMjAxNktvcmVhbkZ1bGxTUUwyMDE2QmFzZSA9ICdXaW5kb3dzX1NlcnZlci0yMDE2LUtvcmVhbi1GdWxsLVNRTF8yMDE2X1NQMV9TdGFuZGFyZCcsXG4gIFdpbmRvd3NTZXJ2ZXIyMDE2S29yZWFuRnVsbEJhc2UgPSAnV2luZG93c19TZXJ2ZXItMjAxNi1Lb3JlYW4tRnVsbC1CYXNlJyxcbiAgV2luZG93c1NlcnZlcjIwMTZKYXBhbmVzZUZ1bGxTUUwyMDE2V2ViID0gJ1dpbmRvd3NfU2VydmVyLTIwMTYtSmFwYW5lc2UtRnVsbC1TUUxfMjAxNl9TUDFfV2ViJyxcbiAgV2luZG93c1NlcnZlcjIwMTZKYXBhbmVzZUZ1bGxTUUwyMDE2U3RhbmRhcmQgPSAnV2luZG93c19TZXJ2ZXItMjAxNi1KYXBhbmVzZS1GdWxsLVNRTF8yMDE2X1NQMV9TdGFuZGFyZCcsXG4gIFdpbmRvd3NTZXJ2ZXIyMDE2SmFwYW5lc2VGdWxsU1FMMjAxNkV4cHJlc3MgPSAnV2luZG93c19TZXJ2ZXItMjAxNi1KYXBhbmVzZS1GdWxsLVNRTF8yMDE2X1NQMV9FeHByZXNzJyxcbiAgV2luZG93c1NlcnZlcjIwMTZKYXBhbmVzZUZ1bGxTUUwyMDE2RW50ZXJwcmlzZSA9ICdXaW5kb3dzX1NlcnZlci0yMDE2LUphcGFuZXNlLUZ1bGwtU1FMXzIwMTZfU1AxX0VudGVycHJpc2UnLFxuICBXaW5kb3dzU2VydmVyMjAxNkphcGFuZXNlRnVsbEJhc2UgPSAnV2luZG93c19TZXJ2ZXItMjAxNi1KYXBhbmVzZS1GdWxsLUJhc2UnLFxuICBXaW5kb3dzU2VydmVyMjAxNkl0YWxpYW5GdWxsQmFzZSA9ICdXaW5kb3dzX1NlcnZlci0yMDE2LUl0YWxpYW4tRnVsbC1CYXNlJyxcbiAgV2luZG93c1NlcnZlcjIwMTZIdW5nYXJpYW5GdWxsQmFzZSA9ICdXaW5kb3dzX1NlcnZlci0yMDE2LUh1bmdhcmlhbi1GdWxsLUJhc2UnLFxuICBXaW5kb3dzU2VydmVyMjAxNkdlcm1hbkZ1bGxCYXNlID0gJ1dpbmRvd3NfU2VydmVyLTIwMTYtR2VybWFuLUZ1bGwtQmFzZScsXG4gIFdpbmRvd3NTZXJ2ZXIyMDE2RnJlbmNoRnVsbEJhc2UgPSAnV2luZG93c19TZXJ2ZXItMjAxNi1GcmVuY2gtRnVsbC1CYXNlJyxcbiAgV2luZG93c1NlcnZlcjIwMTZFbmdsaXNoTmFub0Jhc2UgPSAnV2luZG93c19TZXJ2ZXItMjAxNi1FbmdsaXNoLU5hbm8tQmFzZScsXG4gIFdpbmRvd3NTZXJ2ZXIyMDE2RW5nbGlzaEZ1bGxTUUwyMDE3V2ViID0gJ1dpbmRvd3NfU2VydmVyLTIwMTYtRW5nbGlzaC1GdWxsLVNRTF8yMDE3X1dlYicsXG4gIFdpbmRvd3NTZXJ2ZXIyMDE2RW5nbGlzaEZ1bGxTUUwyMDE3U3RhbmRhcmQgPSAnV2luZG93c19TZXJ2ZXItMjAxNi1FbmdsaXNoLUZ1bGwtU1FMXzIwMTdfU3RhbmRhcmQnLFxuICBXaW5kb3dzU2VydmVyMjAxNkVuZ2xpc2hGdWxsU1FMMjAxN0V4cHJlc3MgPSAnV2luZG93c19TZXJ2ZXItMjAxNi1FbmdsaXNoLUZ1bGwtU1FMXzIwMTdfRXhwcmVzcycsXG4gIFdpbmRvd3NTZXJ2ZXIyMDE2RW5nbGlzaEZ1bGxTUUwyMDE3RW50ZXJwcmlzZSA9ICdXaW5kb3dzX1NlcnZlci0yMDE2LUVuZ2xpc2gtRnVsbC1TUUxfMjAxN19FbnRlcnByaXNlJyxcbn1cblxuLyoqXG4gKiBSZXByZXNlbnRhdGlvbiBvZiBhIG1hY2hpbmUgdG8gYmUgbGF1bmNoZWRcbiAqXG4gKiBDb21iaW5lcyBhbiBBTUkgSUQgd2l0aCBhbiBPUy5cbiAqL1xuZXhwb3J0IGNsYXNzIE1hY2hpbmVJbWFnZSB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyByZWFkb25seSBpbWFnZUlkOiBzdHJpbmcsIHB1YmxpYyByZWFkb25seSBvczogT3BlcmF0aW5nU3lzdGVtKSB7XG4gIH1cbn1cblxuLyoqXG4gKiBUaGUgT1MgdHlwZSBvZiBhIHBhcnRpY3VsYXIgaW1hZ2VcbiAqL1xuZXhwb3J0IGVudW0gT3BlcmF0aW5nU3lzdGVtVHlwZSB7XG4gIExpbnV4LFxuICBXaW5kb3dzLFxufVxuXG4vKipcbiAqIEFic3RyYWN0aW9uIG9mIE9TIGZlYXR1cmVzIHdlIG5lZWQgdG8gYmUgYXdhcmUgb2ZcbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIE9wZXJhdGluZ1N5c3RlbSB7XG4gIHB1YmxpYyBhYnN0cmFjdCBjcmVhdGVVc2VyRGF0YShzY3JpcHRzOiBzdHJpbmdbXSk6IHN0cmluZztcbiAgYWJzdHJhY3QgZ2V0IHR5cGUoKTogT3BlcmF0aW5nU3lzdGVtVHlwZTtcbn1cblxuLyoqXG4gKiBPUyBmZWF0dXJlcyBzcGVjaWFsaXplZCBmb3IgV2luZG93c1xuICovXG5leHBvcnQgY2xhc3MgV2luZG93c09TIGV4dGVuZHMgT3BlcmF0aW5nU3lzdGVtIHtcbiAgcHVibGljIGNyZWF0ZVVzZXJEYXRhKHNjcmlwdHM6IHN0cmluZ1tdKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYDxwb3dlcnNoZWxsPiR7c2NyaXB0cy5qb2luKCdcXG4nKX08L3Bvd2Vyc2hlbGw+YDtcbiAgfVxuXG4gIGdldCB0eXBlKCk6IE9wZXJhdGluZ1N5c3RlbVR5cGUge1xuICAgIHJldHVybiBPcGVyYXRpbmdTeXN0ZW1UeXBlLldpbmRvd3M7XG4gIH1cbn1cblxuLyoqXG4gKiBPUyBmZWF0dXJlcyBzcGVjaWFsaXplZCBmb3IgTGludXhcbiAqL1xuZXhwb3J0IGNsYXNzIExpbnV4T1MgZXh0ZW5kcyBPcGVyYXRpbmdTeXN0ZW0ge1xuICBwdWJsaWMgY3JlYXRlVXNlckRhdGEoc2NyaXB0czogc3RyaW5nW10pOiBzdHJpbmcge1xuICAgIHJldHVybiAnIyEvYmluL2Jhc2hcXG4nICsgc2NyaXB0cy5qb2luKCdcXG4nKTtcbiAgfVxuXG4gIGdldCB0eXBlKCk6IE9wZXJhdGluZ1N5c3RlbVR5cGUge1xuICAgIHJldHVybiBPcGVyYXRpbmdTeXN0ZW1UeXBlLkxpbnV4O1xuICB9XG59XG4iXX0=